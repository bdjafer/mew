-- ===========================================================================
-- OPERATIONS: Basic CRUD for Audit
-- DESCRIPTION: Tests basic operations for the audit ontology
-- FEATURES: Core CRUD operations
-- ===========================================================================

-- ---------------------------------------------------------------------------
-- Create: Config sets
-- ---------------------------------------------------------------------------

--# test_create_dev_config
SPAWN dev_config: ConfigSet {
  name = "development",
  description = "Development environment config",
  environment = "development"
}

--# test_create_prod_config
SPAWN prod_config: ConfigSet {
  name = "production",
  description = "Production environment config",
  environment = "production",
  locked = true
}

-- ---------------------------------------------------------------------------
-- Create: Config items
-- ---------------------------------------------------------------------------

--# test_create_db_config
SPAWN db_url: ConfigItem {
  key = "DATABASE_URL",
  value = "postgres://localhost:5432/dev",
  config_type = "database",
  environment = "development"
}

--# test_create_cache_config
SPAWN cache_url: ConfigItem {
  key = "REDIS_URL",
  value = "redis://localhost:6379",
  config_type = "database",
  environment = "development"
}

--# test_create_secret_config
SPAWN api_secret: ConfigItem {
  key = "API_SECRET",
  value = "secret-value-123",
  config_type = "security",
  sensitive = true,
  environment = "staging"
}

-- ---------------------------------------------------------------------------
-- Link: Config to set
-- ---------------------------------------------------------------------------

--# test_link_configs
LINK belongs_to(#db_url, #dev_config)
LINK belongs_to(#cache_url, #dev_config)

-- ---------------------------------------------------------------------------
-- Create: Change requests
-- ---------------------------------------------------------------------------

--# test_create_change_request
SPAWN change1: ChangeRequest {
  title = "Update database URL",
  description = "Point to new cluster",
  change_type = "update",
  requested_by = "developer@example.com"
}
LINK change_for(#change1, #db_url)

-- ---------------------------------------------------------------------------
-- Create: Snapshots and branches
-- ---------------------------------------------------------------------------

--# test_create_snapshot
SPAWN snap1: Snapshot {
  name = "v1.0.0",
  description = "First release",
  created_by = "admin@example.com"
}
LINK snapshot_of(#snap1, #dev_config)

--# test_create_branch
SPAWN feature_branch: Branch {
  name = "feature/new-cache",
  description = "Testing new cache config",
  created_from = "main"
}
LINK branch_of(#feature_branch, #dev_config)

-- ---------------------------------------------------------------------------
-- Query: Config items
-- ---------------------------------------------------------------------------

--# test_query_all_configs
MATCH i: ConfigItem
RETURN i.key, i.value, i.config_type

--# test_query_database_configs
MATCH i: ConfigItem WHERE i.config_type = "database"
RETURN i.key, i.value

--# test_query_sensitive_configs
MATCH i: ConfigItem WHERE i.sensitive = true
RETURN i.key, i.environment

-- ---------------------------------------------------------------------------
-- Query: Config sets
-- ---------------------------------------------------------------------------

--# test_query_config_sets
MATCH cs: ConfigSet
RETURN cs.name, cs.environment, cs.version

--# test_query_set_with_items
MATCH cs: ConfigSet, i: ConfigItem, belongs_to(i, cs)
RETURN cs.name, i.key, i.value

-- ---------------------------------------------------------------------------
-- Query: Change requests
-- ---------------------------------------------------------------------------

--# test_query_pending_changes
MATCH cr: ChangeRequest WHERE cr.status = "pending"
RETURN cr.title, cr.requested_by

--# test_query_changes_for_config
MATCH cr: ChangeRequest, i: ConfigItem, change_for(cr, i)
RETURN i.key, cr.title, cr.status

-- ---------------------------------------------------------------------------
-- Update: Config values
-- ---------------------------------------------------------------------------

--# test_update_config_value
SET #db_url { value = "postgres://db.cluster.local:5432/dev" }

--# test_approve_change
SET #change1 {
  status = "approved",
  approved_by = "admin@example.com",
  approved_at = now()
}

-- ---------------------------------------------------------------------------
-- Update: Config set
-- ---------------------------------------------------------------------------

--# test_increment_version
SET #dev_config { version = 2 }

--# test_lock_config
SET #dev_config { locked = true }

-- ---------------------------------------------------------------------------
-- Cleanup
-- ---------------------------------------------------------------------------

--# test_cleanup_changes
MATCH cr: ChangeRequest KILL cr

--# test_cleanup_branches
MATCH b: Branch KILL b

--# test_cleanup_snapshots
MATCH s: Snapshot KILL s

--# test_cleanup_configs
MATCH i: ConfigItem KILL i

--# test_cleanup_sets
MATCH cs: ConfigSet KILL cs
