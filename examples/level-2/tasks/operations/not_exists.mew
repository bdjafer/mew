-- ===========================================================================
-- SCENARIO: NOT EXISTS Patterns
-- DESCRIPTION: Tests negative patterns for finding entities without relationships
-- FOCUS: NOT EXISTS (unique to this ontology's tests)
-- ===========================================================================

-- ---------------------------------------------------------------------------
-- SETUP
-- ---------------------------------------------------------------------------

--# test_setup_untagged_task
SPAWN untagged: Task {
  title = "Untagged task",
  status = "todo",
  priority = 3
}
--@ expect:ok

--# test_setup_orphan_task
SPAWN orphan: Task {
  title = "Orphan task",
  status = "todo",
  priority = 2
}
--@ expect:ok

--# test_setup_isolated_task
SPAWN isolated: Task {
  title = "Isolated task",
  status = "todo",
  priority = 1
}
--@ expect:ok

-- ---------------------------------------------------------------------------
-- NOT EXISTS: Tasks without tags
-- ---------------------------------------------------------------------------

--# test_tasks_without_tags
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)-[:tagged]->(tag:Tag)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 3
--@ expect:has_row { title = "Untagged task" }
--@ expect:has_row { title = "Orphan task" }
--@ expect:has_row { title = "Isolated task" }

-- ---------------------------------------------------------------------------
-- NOT EXISTS: Tasks without subtasks
-- ---------------------------------------------------------------------------

--# test_tasks_without_subtasks
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)<-[:subtask_of]-(st:SubTask)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 5

-- ---------------------------------------------------------------------------
-- NOT EXISTS: Tasks that don't block anything
-- ---------------------------------------------------------------------------

--# test_tasks_not_blocking_others
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)-[:blocks]->(:Task)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 5
--@ expect:has_row { title = "Isolated task" }

-- ---------------------------------------------------------------------------
-- NOT EXISTS: Tasks not blocked by anything
-- ---------------------------------------------------------------------------

--# test_tasks_not_blocked
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)<-[:blocks]-(:Task)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 4

-- ---------------------------------------------------------------------------
-- COMBINING NOT EXISTS WITH OTHER CONDITIONS
-- ---------------------------------------------------------------------------

--# test_todo_tasks_without_tags
MATCH (t:Task)
WHERE t.status = "todo" AND NOT EXISTS {
  MATCH (t)-[:tagged]->(:Tag)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 3

--# test_high_priority_tasks_without_blockers
MATCH (t:Task)
WHERE t.priority >= 4 AND NOT EXISTS {
  MATCH (t)<-[:blocks]-(:Task)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 1

-- ---------------------------------------------------------------------------
-- NESTED NOT EXISTS
-- ---------------------------------------------------------------------------

--# test_tasks_without_urgent_tags
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)-[:tagged]->(tag:Tag)
  WHERE tag.name = "urgent"
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 5

--# test_tasks_without_completed_subtasks
MATCH (t:Task)
WHERE EXISTS {
  MATCH (t)<-[:subtask_of]-(st:SubTask)
} AND NOT EXISTS {
  MATCH (t)<-[:subtask_of]-(st:SubTask)
  WHERE st.title CONTAINS "completed"
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 1

-- ---------------------------------------------------------------------------
-- NOT EXISTS WITH TRANSITIVE PATTERNS
-- ---------------------------------------------------------------------------

--# test_tasks_with_no_transitive_dependencies
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)-[:blocks+]->(:Task)
} AND NOT EXISTS {
  MATCH (t)<-[:blocks+]-(:Task)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 3
--@ expect:has_row { title = "Isolated task" }

-- ---------------------------------------------------------------------------
-- NOT EXISTS: Tags not used by any task
-- ---------------------------------------------------------------------------

--# test_setup_unused_tag
SPAWN unused_tag: Tag {
  name = "unused",
  color = "#888888"
}
--@ expect:ok

--# test_unused_tags
MATCH (tag:Tag)
WHERE NOT EXISTS {
  MATCH (t:Task)-[:tagged]->(tag)
}
RETURN tag.name
ORDER BY tag.name
--@ expect:rows >= 1
--@ expect:has_row { name = "unused" }

-- ---------------------------------------------------------------------------
-- NOT EXISTS: Complex combinations
-- ---------------------------------------------------------------------------

--# test_tasks_without_tags_or_subtasks
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)-[:tagged]->(:Tag)
} AND NOT EXISTS {
  MATCH (t)<-[:subtask_of]->(:SubTask)
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 3

--# test_tasks_not_related_to_api_task
MATCH (t:Task)
WHERE t.title != "Implement API" AND NOT EXISTS {
  MATCH (api:Task)-[:blocks+]->(t)
  WHERE api.title = "Implement API"
} AND NOT EXISTS {
  MATCH (t)-[:blocks+]->(api:Task)
  WHERE api.title = "Implement API"
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 3

-- ---------------------------------------------------------------------------
-- NOT EXISTS WITH EDGE ATTRIBUTES
-- ---------------------------------------------------------------------------

--# test_setup_blocking_subtask
SPAWN blocking_st: SubTask {
  title = "Blocking subtask",
  priority = 5,
  is_blocking = true
}
--@ expect:ok

--# test_setup_nonblocking_subtask
SPAWN nonblocking_st: SubTask {
  title = "Non-blocking subtask",
  priority = 3,
  is_blocking = false
}
--@ expect:ok

--# test_subtasks_that_are_not_blocking
MATCH (st:SubTask)
WHERE st.is_blocking = false OR NOT EXISTS {
  MATCH (st)<-[:subtask_of]-(t:Task)
}
RETURN st.title
ORDER BY st.title
--@ expect:rows >= 2

-- ---------------------------------------------------------------------------
-- MULTIPLE NOT EXISTS CONDITIONS
-- ---------------------------------------------------------------------------

--# test_truly_isolated_tasks
MATCH (t:Task)
WHERE NOT EXISTS { MATCH (t)-[:tagged]->(:Tag) }
AND NOT EXISTS { MATCH (t)<-[:subtask_of]->(:SubTask) }
AND NOT EXISTS { MATCH (t)-[:blocks]->(:Task) }
AND NOT EXISTS { MATCH (t)<-[:blocks]-(:Task) }
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 3
--@ expect:has_row { title = "Isolated task" }

-- ---------------------------------------------------------------------------
-- NOT EXISTS FOR FINDING GAPS
-- ---------------------------------------------------------------------------

--# test_development_tasks_without_dev_tag
MATCH (t:Task)
WHERE t.title CONTAINS "API" OR t.title CONTAINS "test"
AND NOT EXISTS {
  MATCH (t)-[:tagged]->(tag:Tag)
  WHERE tag.name = "development"
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 0

--# test_urgent_priority_without_urgent_tag
MATCH (t:Task)
WHERE t.priority >= 5 AND NOT EXISTS {
  MATCH (t)-[:tagged]->(tag:Tag)
  WHERE tag.name = "urgent"
}
RETURN t.title
ORDER BY t.title
--@ expect:rows >= 1

-- ---------------------------------------------------------------------------
-- NOT EXISTS WITH AGGREGATIONS
-- ---------------------------------------------------------------------------

--# test_count_untagged_tasks
MATCH (t:Task)
WHERE NOT EXISTS {
  MATCH (t)-[:tagged]->(:Tag)
}
RETURN COUNT(t) AS untagged_count
--@ expect:rows = 1
--@ expect:has_row { untagged_count >= 3 }

--# test_count_orphaned_subtasks
MATCH (st:SubTask)
WHERE NOT EXISTS {
  MATCH (st)-[:subtask_of]->(:Task)
}
RETURN COUNT(st) AS orphan_count
--@ expect:rows = 1
--@ expect:has_row { orphan_count >= 2 }

-- ---------------------------------------------------------------------------
-- CLEANUP
-- ---------------------------------------------------------------------------

--# test_cleanup_test_entities
MATCH (t:Task)
WHERE t.title IN ["Untagged task", "Orphan task", "Isolated task"]
KILL t
--@ expect:ok

--# test_cleanup_test_subtasks
MATCH (st:SubTask)
WHERE st.title IN ["Blocking subtask", "Non-blocking subtask"]
KILL st
--@ expect:ok

--# test_cleanup_unused_tag
MATCH (tag:Tag)
WHERE tag.name = "unused"
KILL tag
--@ expect:ok
