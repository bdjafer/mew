-- ===========================================================================
-- SCENARIO: No Self Edge Constraint
-- DESCRIPTION: Tests that [no_self] edges prevent linking to self
-- FOCUS: no_self modifier (unique to this ontology's tests)
-- ===========================================================================

-- ---------------------------------------------------------------------------
-- SETUP
-- ---------------------------------------------------------------------------

--# test_setup_employee_for_self_link
-- Need to spawn a Manager (not just Employee) to test no_self on reports_to
-- because reports_to(employee: Employee, manager: Manager) requires Manager in position 2
SPAWN self_test_mgr: Manager {
  first_name = "SelfTest",
  last_name = "User",
  email = "selftest@company.com",
  employee_id = "EMP999001",
  hire_date = now(),
  salary = 90000.0,
  management_level = 2,
  budget_authority = 50000.0
}
--@ expect:ok

-- ---------------------------------------------------------------------------
-- NO_SELF VIOLATION: reports_to edge
-- ---------------------------------------------------------------------------

--# test_reports_to_self_should_fail
MATCH m: Manager
WHERE m.employee_id = "EMP999001"
LINK reports_to(m, m)
--@ expect:error = "NoSelfViolation"

-- ---------------------------------------------------------------------------
-- VERIFY NO EDGE CREATED
-- ---------------------------------------------------------------------------

--# test_verify_no_self_edge_created
MATCH m: Manager, reports_to(m, m) AS r
WHERE m.employee_id = "EMP999001"
RETURN count(r) AS self_edges
--@ expect:rows = 1
--@ expect:has_row { self_edges = 0 }

-- ---------------------------------------------------------------------------
-- VALID LINK TO DIFFERENT ENTITY
-- ---------------------------------------------------------------------------

--# test_reports_to_different_employee_succeeds
MATCH e: Manager, m: Manager
WHERE e.employee_id = "EMP999001" AND m.first_name = "Charlie"
LINK reports_to(e, m)
--@ expect:ok

--# test_verify_valid_link_created
MATCH e: Manager, m: Manager, reports_to(e, m)
WHERE e.employee_id = "EMP999001"
RETURN e.first_name, m.first_name
--@ expect:rows = 1
--@ expect:has_row { e.first_name = "SelfTest", m.first_name = "Charlie" }

-- ---------------------------------------------------------------------------
-- NO_SELF ON OTHER EDGES
-- ---------------------------------------------------------------------------

--# test_setup_department_for_self_link
SPAWN self_dept: Department {
  code = "SELF",
  name = "Self Department",
  budget = 100000.0
}
--@ expect:ok

--# test_parent_dept_self_should_fail
MATCH d: Department
WHERE d.code = "SELF"
LINK parent_dept(d, d)
--@ expect:error = "NoSelfViolation"

--# test_verify_no_parent_dept_self_edge
MATCH d: Department, parent_dept(d, d) AS r
WHERE d.code = "SELF"
RETURN count(r) AS self_edges
--@ expect:rows = 1
--@ expect:has_row { self_edges = 0 }

-- ---------------------------------------------------------------------------
-- ATTEMPT TO CREATE SELF-LINK VIA UPDATE (if supported)
-- ---------------------------------------------------------------------------

--# test_update_to_create_self_link_should_fail
-- Verify the test setup: our test manager should be linked to Charlie
MATCH e: Manager, m: Manager, reports_to(e, m)
WHERE e.employee_id = "EMP999001" AND m.first_name = "Charlie"
RETURN e.first_name, m.first_name
--@ expect:rows = 1

-- ---------------------------------------------------------------------------
-- VERIFY NO_SELF DOESN'T AFFECT DIFFERENT ENTITIES
-- ---------------------------------------------------------------------------

--# test_multiple_employees_reporting_to_same_manager
-- Count employees reporting to Charlie
MATCH e: Employee, m: Manager, reports_to(e, m)
WHERE m.first_name = "Charlie"
RETURN count(e) AS report_count
--@ expect:rows = 1

-- ---------------------------------------------------------------------------
-- CIRCULAR DEPENDENCIES (NOT BLOCKED BY NO_SELF)
-- ---------------------------------------------------------------------------

--# test_setup_circular_employees
-- Both need to be Managers for reports_to to work in both directions
SPAWN circ_mgr1: Manager {
  first_name = "Circular",
  last_name = "One",
  email = "circ1@company.com",
  employee_id = "EMP999002",
  hire_date = now(),
  salary = 80000.0,
  management_level = 1,
  budget_authority = 10000.0
}
--@ expect:ok

--# test_setup_circular_employee_2
SPAWN circ_mgr2: Manager {
  first_name = "Circular",
  last_name = "Two",
  email = "circ2@company.com",
  employee_id = "EMP999003",
  hire_date = now(),
  salary = 80000.0,
  management_level = 1,
  budget_authority = 10000.0
}
--@ expect:ok

--# test_circular_dependency_allowed
MATCH m1: Manager, m2: Manager
WHERE m1.employee_id = "EMP999002" AND m2.employee_id = "EMP999003"
LINK reports_to(m1, m2)
--@ expect:ok

--# test_circular_dependency_reverse_allowed
MATCH m1: Manager, m2: Manager
WHERE m1.employee_id = "EMP999002" AND m2.employee_id = "EMP999003"
LINK reports_to(m2, m1)
--@ expect:ok

--# test_verify_circular_dependency_exists
MATCH m1: Manager, m2: Manager, reports_to(m1, m2), reports_to(m2, m1)
WHERE m1.employee_id = "EMP999002"
RETURN m1.first_name, m2.first_name
--@ expect:rows = 1
--@ expect:has_row { m1.first_name = "Circular", m2.first_name = "Circular" }

-- ---------------------------------------------------------------------------
-- CLEANUP
-- ---------------------------------------------------------------------------

--# test_cleanup_self_test_entities
MATCH m: Manager
WHERE m.employee_id IN ["EMP999001", "EMP999002", "EMP999003"]
KILL m
--@ expect:ok

--# test_cleanup_self_dept
MATCH d: Department
WHERE d.code = "SELF"
KILL d
--@ expect:ok

