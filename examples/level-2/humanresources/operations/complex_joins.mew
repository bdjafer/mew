-- ===========================================================================
-- SCENARIO: Complex Multi-Hop Joins
-- DESCRIPTION: Tests queries spanning multiple edge relationships
-- FOCUS: Complex relational queries (unique to this ontology's tests)
-- ===========================================================================

-- ---------------------------------------------------------------------------
-- BASIC TWO-HOP JOINS
-- ---------------------------------------------------------------------------

--# test_employees_to_departments_to_parent
MATCH (e:Employee)-[:in_department]->(d:Department)-[:parent_dept]->(parent:Department)
RETURN e.first_name, d.name AS dept, parent.name AS parent_dept
ORDER BY e.first_name

--# test_employees_skills_to_courses
MATCH (e:Employee)-[:has_skill]->(s:Skill)<-[:teaches_skill]-(c:Course)
RETURN e.first_name, s.name, c.name
ORDER BY e.first_name, s.name

-- ---------------------------------------------------------------------------
-- THREE-HOP JOINS
-- ---------------------------------------------------------------------------

--# test_employee_to_role_to_skill_requirement_to_skill
MATCH (e:Employee)-[:has_role]->(r:Role)-[:requires_skill]->(s:Skill)
RETURN e.first_name, r.title, s.name
ORDER BY e.first_name

--# test_employee_manager_office_chain
MATCH (e:Employee)-[:reports_to]->(m:Manager)-[:works_at]->(o:Office)
WHERE e.first_name IN ["Alice", "Bob"]
RETURN e.first_name, m.first_name AS manager, o.name AS office
ORDER BY e.first_name

-- ---------------------------------------------------------------------------
-- FOUR-HOP JOINS
-- ---------------------------------------------------------------------------

--# test_employee_to_course_to_skill_to_role
MATCH (e:Employee)-[:completed_course]->(c:Course)-[:teaches_skill]->(s:Skill)<-[:requires_skill]-(r:Role)
RETURN e.first_name, c.name, s.name, r.title

-- ---------------------------------------------------------------------------
-- MULTI-PATH JOINS (Same entities via different paths)
-- ---------------------------------------------------------------------------

--# test_employee_has_skill_and_completed_course_for_same_skill
MATCH (e:Employee)-[:has_skill]->(s:Skill)
MATCH (e)-[:completed_course]->(c:Course)-[:teaches_skill]->(s)
RETURN e.first_name, s.name, c.name

--# test_employee_role_and_skill_alignment
MATCH (e:Employee)-[:has_role]->(r:Role)
MATCH (e)-[:has_skill]->(s:Skill)
MATCH (r)-[:requires_skill]->(s)
RETURN e.first_name, r.title, s.name
ORDER BY e.first_name

-- ---------------------------------------------------------------------------
-- BRANCHING JOINS (One entity to multiple related entities)
-- ---------------------------------------------------------------------------

--# test_employee_multiple_skills
MATCH (e:Employee)-[:has_skill]->(s:Skill)
WHERE e.first_name = "Alice"
RETURN e.first_name, COLLECT(s.name) AS skills

--# test_manager_multiple_reports
MATCH (m:Manager)<-[:reports_to]-(e:Employee)
WHERE m.first_name = "Charlie"
RETURN m.first_name, COLLECT(e.first_name) AS reports

-- ---------------------------------------------------------------------------
-- TRANSITIVE REPORTING CHAINS
-- ---------------------------------------------------------------------------

--# test_two_level_reporting_chain
MATCH (e:Employee)-[:reports_to]->(m:Manager)-[:reports_to]->(exec:Executive)
WHERE e.first_name IN ["Alice", "Bob"]
RETURN e.first_name, m.first_name AS manager, exec.first_name AS executive
ORDER BY e.first_name

-- ---------------------------------------------------------------------------
-- JOINS WITH AGGREGATIONS
-- ---------------------------------------------------------------------------

--# test_count_employees_per_manager
MATCH (m:Manager)<-[:reports_to]-(e:Employee)
RETURN m.first_name, COUNT(e) AS report_count
ORDER BY report_count DESC

--# test_department_employee_skill_count
MATCH (d:Department)<-[:in_department]-(e:Employee)-[:has_skill]->(s:Skill)
RETURN d.name, COUNT(DISTINCT e) AS employee_count, COUNT(DISTINCT s) AS skill_count
ORDER BY d.name

--# test_office_capacity_vs_occupancy
MATCH (o:Office)
OPTIONAL MATCH (o)<-[:works_at]-(e:Employee)
RETURN o.name, o.capacity, COUNT(e) AS occupancy
ORDER BY o.name

-- ---------------------------------------------------------------------------
-- JOINS WITH FILTERS ON MULTIPLE HOPS
-- ---------------------------------------------------------------------------

--# test_high_salary_employees_in_headquarters
MATCH (e:Employee)-[:works_at]->(o:Office)
WHERE e.salary > 100000.0 AND o.is_headquarters = true
RETURN e.first_name, e.salary, o.name
ORDER BY e.salary DESC

--# test_expert_employees_in_management_roles
MATCH (e:Employee)-[:has_role]->(r:Role)
MATCH (e)-[:has_skill]->(s:Skill)
WHERE r.is_management = true AND s.category = "Management"
RETURN e.first_name, r.title, s.name
ORDER BY e.first_name

-- ---------------------------------------------------------------------------
-- COMPLEX EXISTENCE CHECKS IN JOINS
-- ---------------------------------------------------------------------------

--# test_employees_with_certification_and_course_completion
MATCH (e:Employee)-[:has_certification]->(cert:Certification)
MATCH (e)-[:completed_course]->(c:Course)
RETURN e.first_name, cert.name, c.name

--# test_managers_heading_departments_with_employees
MATCH (m:Manager)-[:heads_department]->(d:Department)
MATCH (d)<-[:in_department]-(e:Employee)
RETURN m.first_name, d.name, COUNT(e) AS employee_count
ORDER BY employee_count DESC

-- ---------------------------------------------------------------------------
-- OPTIONAL JOINS FOR INCOMPLETE PATHS
-- ---------------------------------------------------------------------------

--# test_employees_with_optional_certifications
MATCH (e:Employee)
OPTIONAL MATCH (e)-[:has_certification]->(cert:Certification)
RETURN e.first_name, cert.name
ORDER BY e.first_name

--# test_skills_with_optional_course_and_employees
MATCH (s:Skill)
OPTIONAL MATCH (s)<-[:teaches_skill]-(c:Course)
OPTIONAL MATCH (s)<-[:has_skill]-(e:Employee)
RETURN s.name, c.name, COUNT(e) AS employee_count
ORDER BY s.name

-- ---------------------------------------------------------------------------
-- SELF-JOIN PATTERNS (Same type multiple times)
-- ---------------------------------------------------------------------------

--# test_employees_sharing_same_office
MATCH (e1:Employee)-[:works_at]->(o:Office)<-[:works_at]-(e2:Employee)
WHERE e1.employee_id < e2.employee_id
RETURN o.name, e1.first_name, e2.first_name
ORDER BY o.name, e1.first_name
