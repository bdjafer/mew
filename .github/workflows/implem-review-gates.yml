name: "Implem: Review Gates"

# Runs quality review and spec compliance checks in parallel when a PR needs review.
# Triggered when 'agent/needs-review' label is present.

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  pull_request_target:
    types: [labeled]

permissions:
  contents: write         # Push commits (for spec revision)
  pull-requests: write    # Update PR labels and comments
  issues: write           # Post comments
  id-token: write         # For OAuth authentication

jobs:
  quality-review:
    if: |
      !github.event.pull_request.draft &&
      contains(github.event.pull_request.labels.*.name, 'agent/needs-review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Load skill prompt
        id: skill
        run: |
          {
            echo "prompt<<SKILL_EOF"
            cat ".claude/skills/scenarios->implem/review-pr.md"
            echo "SKILL_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code - Quality Review
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ steps.skill.outputs.prompt }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_bots: '*'
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 40
            --allowedTools Bash,Read,Glob,Grep

  spec-compliance:
    if: |
      !github.event.pull_request.draft &&
      contains(github.event.pull_request.labels.*.name, 'agent/needs-review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Load skill prompt
        id: skill
        run: |
          {
            echo "prompt<<SKILL_EOF"
            cat ".claude/skills/scenarios->implem/compare-spec.md"
            echo "SKILL_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code - Spec Compliance
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ steps.skill.outputs.prompt }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_bots: '*'
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 60
            --allowedTools Bash,Read,Glob,Grep,Edit,Write

  # Check if both gates passed and merge directly
  auto-merge:
    needs: [quality-review, spec-compliance]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check gates and merge if ready
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            // Get current labels
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });

            const labels = pr.labels.map(l => l.name);

            // Check if both gates passed
            const qualityPassed = labels.includes('gate/quality-passed');
            const specPassed = labels.includes('gate/spec-passed');
            const awaitingHuman = labels.includes('awaiting-human');

            if (qualityPassed && specPassed && !awaitingHuman) {
              // Add ready-to-merge label for tracking
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ['ready-to-merge']
              });

              // Merge the PR directly
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prNumber,
                  merge_method: 'squash',
                  commit_title: pr.title,
                  commit_message: `Auto-merged after passing all gates.\n\nGates passed:\n- gate/quality-passed\n- gate/spec-passed`
                });
                console.log('Both gates passed. PR merged successfully.');

                // Delete the branch
                try {
                  await github.rest.git.deleteRef({
                    owner,
                    repo,
                    ref: `heads/${pr.head.ref}`
                  });
                  console.log('Branch deleted.');
                } catch (e) {
                  console.log('Could not delete branch:', e.message);
                }
              } catch (e) {
                console.log('Merge failed:', e.message);
                core.setFailed(`Merge failed: ${e.message}`);
              }
            } else {
              console.log('Gates status:', { qualityPassed, specPassed, awaitingHuman });
              console.log('Not all gates passed or awaiting human review. Skipping merge.');
            }
