name: "Implem: Auto-Merge"

# Automatically merges PRs that have passed all gates.
# Triggered when 'ready-to-merge' label is added.

on:
  pull_request_target:
    types: [labeled]

permissions:
  contents: write         # Merge PR
  pull-requests: write    # Update PR status

jobs:
  auto-merge:
    if: contains(github.event.pull_request.labels.*.name, 'ready-to-merge')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Final test verification
        run: |
          cd mew && cargo test --workspace
          echo "All tests passed."

      - name: Merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --squash \
            --delete-branch \
            --body "Auto-merged after passing all gates.

          Gates passed:
          - gate/quality-passed
          - gate/spec-passed

          Merged by: implem-auto-merge workflow"

      - name: Post merge comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '## Merged\n\nThis PR has been automatically merged after passing all quality and spec compliance gates.'
            });
