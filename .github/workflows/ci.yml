name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # BLOCKING: These must pass for CI to be green
  # ============================================================================
  
  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mew/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check formatting
        working-directory: mew
        run: cargo fmt --all -- --check
      
      - name: Clippy
        working-directory: mew
        run: cargo clippy --workspace --all-targets -- -D warnings
      
      - name: Build
        working-directory: mew
        run: cargo build --workspace --all-targets

  # ============================================================================
  # INFORMATIONAL: Test results - TDD mode means failures are expected
  # ============================================================================
  
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: true
    outputs:
      unit_passed: ${{ steps.unit.outputs.passed }}
      unit_failed: ${{ steps.unit.outputs.failed }}
      integration_passed: ${{ steps.integration.outputs.passed }}
      integration_failed: ${{ steps.integration.outputs.failed }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mew/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run unit tests
        id: unit
        working-directory: mew
        continue-on-error: true
        run: |
          set +e
          output=$(cargo test --workspace --lib 2>&1)
          exit_code=$?
          echo "$output"
          
          passed=$(echo "$output" | grep -oE '[0-9]+ passed' | awk '{sum+=$1} END {print sum+0}')
          failed=$(echo "$output" | grep -oE '[0-9]+ failed' | awk '{sum+=$1} END {print sum+0}')
          
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "### Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Passed: $passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Failed: $failed" >> $GITHUB_STEP_SUMMARY
          exit 0
      
      - name: Run integration tests
        id: integration
        working-directory: mew
        continue-on-error: true
        run: |
          set +e
          output=$(cargo test -p mew-tests --no-fail-fast 2>&1)
          exit_code=$?
          echo "$output"
          
          passed=$(echo "$output" | grep -oE '[0-9]+ passed' | awk '{sum+=$1} END {print sum+0}')
          failed=$(echo "$output" | grep -oE '[0-9]+ failed' | awk '{sum+=$1} END {print sum+0}')
          
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "### Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Passed: $passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Failed: $failed" >> $GITHUB_STEP_SUMMARY
          exit 0
      
      - name: Test summary
        run: |
          echo "## üìä Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Passed | Failed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit | ${{ steps.unit.outputs.passed }} | ${{ steps.unit.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ steps.integration.outputs.passed }} | ${{ steps.integration.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ‚ÑπÔ∏è **TDD Mode**: Test failures are expected during development." >> $GITHUB_STEP_SUMMARY
          echo "> Focus on making progress - watch the passed count grow!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # CROSS-PLATFORM: Build verification on other platforms
  # ============================================================================
  
  build-platforms:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build
        working-directory: mew
        run: cargo build --workspace

  # ============================================================================
  # SUMMARY: Post overall status
  # ============================================================================
  
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [build, test, build-platforms]
    if: always()
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Build/Lint failed - this must be fixed"
            exit 1
          fi
          echo "‚úÖ Build and lint passed"
          echo ""
          echo "üìä Test progress (TDD mode - failures expected):"
          echo "   Unit: ${{ needs.test.outputs.unit_passed }} passed, ${{ needs.test.outputs.unit_failed }} failed"
          echo "   Integration: ${{ needs.test.outputs.integration_passed }} passed, ${{ needs.test.outputs.integration_failed }} failed"
