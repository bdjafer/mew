name: "Scenarios: Verify"

# Verifies scenario/test pairs after merges to main.
# Uses labels to chain phases (WORKFLOW_PAT triggers subsequent workflows).
#
# Phase 1 (push): Create verification PR with scenarios/needs-verify label
# Phase 2 (label): Claude agent verifies assertions, fixes if needed
# Phase 3 (label): Independent confirmation, auto-merge if verified

on:
  push:
    branches: [main]
    paths:
      - 'examples/level-*/*/operations/*.mew'
      - 'examples/level-*/*/seeds/*.mew'
      - 'examples/level-*/*/ontology.mew'
      - 'mew/tests/tests/level*.rs'

  pull_request_target:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  create-verification-pr:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: detect
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          OP_FILES="" TEST_FILES=""

          for file in $CHANGED; do
            [[ "$file" =~ ^examples/level-[0-9]+/[^/]+/operations/.+\.mew$ ]] && OP_FILES="$OP_FILES $file"
            [[ "$file" =~ ^mew/tests/tests/level[0-9]+_.+\.rs$ ]] && TEST_FILES="$TEST_FILES $file"
          done

          if [ -z "$OP_FILES$TEST_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "op_files=$OP_FILES" >> $GITHUB_OUTPUT
            echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Create verification PR
        if: steps.detect.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="verify/scenarios-$(date +%s)"
          git checkout -b "$BRANCH"
          git commit --allow-empty -m "chore: trigger scenario verification"
          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create --title "verify: scenario assertions" \
            --body "Scenario verification PR. Auto-closes after verification." \
            --base main --head "$BRANCH")
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

          gh pr edit "$PR_NUMBER" --add-label "scenarios/needs-verify"
          echo "Created PR #$PR_NUMBER"

  verify:
    if: github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'scenarios/needs-verify')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 2

      - name: Setup PR branch
        run: |
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          git fetch origin "$PR_BRANCH"
          git checkout -B "$PR_BRANCH" "origin/$PR_BRANCH"
          git merge origin/main --no-edit || true
          git push origin "$PR_BRANCH" || true

      - uses: dtolnay/rust-toolchain@stable

      - name: Detect changed files
        id: detect
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only origin/main~1 origin/main)
          OP_FILES="" TEST_FILES=""

          for file in $CHANGED; do
            [[ "$file" =~ ^examples/level-[0-9]+/[^/]+/operations/.+\.mew$ ]] && OP_FILES="$OP_FILES $file"
            [[ "$file" =~ ^mew/tests/tests/level[0-9]+_.+\.rs$ ]] && TEST_FILES="$TEST_FILES $file"
          done

          echo "op_files=$OP_FILES" >> $GITHUB_OUTPUT
          echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT

      - name: Load skill prompt
        id: skill
        run: |
          OP_FILES="${{ steps.detect.outputs.op_files }}"
          TEST_FILES="${{ steps.detect.outputs.test_files }}"
          {
            echo "prompt<<SKILL_EOF"
            echo "# Scenario Verification"
            echo ""

            if [ -n "$OP_FILES" ]; then
              echo "## Changed Operation Files"
              echo "Verify these operation files directly:"
              for FILE in $OP_FILES; do
                echo "- \`$FILE\`"
              done
              echo ""
            fi

            if [ -n "$TEST_FILES" ]; then
              echo "## Changed Test Files"
              echo "These test files were modified:"
              for FILE in $TEST_FILES; do
                echo "- \`$FILE\`"
              done
              echo ""
              echo "**IMPORTANT:** For test file changes, run \`git diff HEAD~1 HEAD\` to see what assertions changed."
              echo "Only verify the SPECIFIC operations whose assertions were modified in the diff."
              echo "Do NOT verify all operations in the ontology - only those affected by the diff."
              echo ""
            fi

            cat ".claude/skills/specs-to-scenarios/verify-scenario.md"
            echo "SKILL_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code - Verify Scenarios
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ steps.skill.outputs.prompt }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.WORKFLOW_PAT }}
          allowed_bots: '*'
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 150
            --allowedTools Bash,Read,Glob,Grep,Edit,Write,Task

      - name: Handle result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOW_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const { execSync } = require('child_process');
            const status = execSync('git status --porcelain').toString().trim();

            if (!status) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: '## ✅ Verification Passed\n\nAll assertions correct. No changes needed.'
              });
              await github.rest.pulls.update({ owner, repo, pull_number: prNumber, state: 'closed' });
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              await github.rest.git.deleteRef({ owner, repo, ref: `heads/${pr.data.head.ref}` }).catch(() => {});
              console.log('Verification passed - PR closed');
            } else {
              const prBranch = '${{ github.event.pull_request.head.ref }}';
              execSync('git config user.name "github-actions[bot]"');
              execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
              execSync('git add -A && git commit -m "fix: correct scenario assertions"');
              execSync(`git push origin HEAD:${prBranch}`);

              await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: '## ⚠️ Issues Found\n\nIncorrect assertions fixed. Requesting independent confirmation.'
              });
              await github.rest.issues.removeLabel({ owner, repo, issue_number: prNumber, name: 'scenarios/needs-verify' }).catch(() => {});
              await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['scenarios/needs-confirm'] });
              console.log('Issues found - awaiting confirmation');
            }

  confirm:
    if: github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'scenarios/needs-confirm')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Load skill prompt
        id: skill
        run: |
          {
            echo "prompt<<SKILL_EOF"
            cat ".claude/skills/specs-to-scenarios/confirm-fix.md"
            echo "SKILL_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ steps.skill.outputs.prompt }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.WORKFLOW_PAT }}
          allowed_bots: '*'
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 80
            --allowedTools Bash,Read,Glob,Grep

      - name: Handle result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOW_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            const labels = pr.labels.map(l => l.name);

            if (labels.includes('scenarios/verified')) {
              try {
                await github.rest.pulls.merge({
                  owner, repo, pull_number: prNumber,
                  merge_method: 'squash',
                  commit_title: 'fix: correct scenario assertions',
                  commit_message: 'Auto-merged after independent verification.'
                });
                await github.rest.git.deleteRef({ owner, repo, ref: `heads/${pr.head.ref}` });
                console.log('PR merged');
              } catch (e) {
                console.log('Merge failed:', e.message);
              }
            } else if (labels.includes('scenarios/awaiting-human')) {
              console.log('PR requires human review');
            } else {
              console.log('Confirmation incomplete - labels:', labels);
            }
