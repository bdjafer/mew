name: "Scenarios: Verify"

# Verifies scenario/test pairs after merges.
# Phase 1 (push): Creates a verification PR with the scenarios/needs-verify label
# Phase 2 (label): Runs Claude agent to verify assertions
# Phase 3 (label): Independent confirmation of fixes

# NOTE: The verify/confirm phases require label events because claude-code-action
# only supports PR-related events. The label added in Phase 1 doesn't trigger
# Phase 2 due to GITHUB_TOKEN limitations. Toggle the label manually to trigger,
# or use: gh pr edit <number> --remove-label "scenarios/needs-verify" && \
#         gh pr edit <number> --add-label "scenarios/needs-verify"

on:
  push:
    branches: [main]
    paths:
      - 'examples/level-*/*/operations/*.mew'
      - 'examples/level-*/*/seeds/*.mew'
      - 'examples/level-*/*/ontology.mew'
      - 'mew/tests/tests/level*.rs'

  pull_request_target:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # Phase 1: On push, detect changes and create verification PR
  create-verification-pr:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Detect changed ontologies
        id: detect
        run: |
          # Get changed files
          CHANGED=$(git diff --name-only HEAD~1 HEAD)

          # Extract unique level/ontology pairs
          PAIRS=""

          for file in $CHANGED; do
            if [[ "$file" =~ ^examples/level-([0-9]+)/([^/]+)/ ]]; then
              LEVEL="${BASH_REMATCH[1]}"
              ONTOLOGY="${BASH_REMATCH[2]}"
              PAIR="${LEVEL}:${ONTOLOGY}"
              if [[ ! "$PAIRS" =~ "$PAIR" ]]; then
                PAIRS="$PAIRS $PAIR"
              fi
            fi
          done

          for file in $CHANGED; do
            if [[ "$file" =~ ^mew/tests/tests/level([0-9]+)_([^.]+)\.rs$ ]]; then
              LEVEL="${BASH_REMATCH[1]}"
              ONTOLOGY="${BASH_REMATCH[2]}"
              PAIR="${LEVEL}:${ONTOLOGY}"
              if [[ ! "$PAIRS" =~ "$PAIR" ]]; then
                PAIRS="$PAIRS $PAIR"
              fi
            fi
          done

          if [ -z "$PAIRS" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "pairs=$PAIRS" >> $GITHUB_OUTPUT
            echo "Detected changes: $PAIRS"
          fi

      - name: Create verification PR
        id: create-pr
        if: steps.detect.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          BRANCH="verify/scenarios-$(date +%s)"
          git checkout -b "$BRANCH"

          # Create empty commit to trigger PR
          git commit --allow-empty -m "chore: trigger scenario verification"
          git push -u origin "$BRANCH"

          # Create PR
          PAIRS="${{ steps.detect.outputs.pairs }}"
          BODY="## Scenario Verification

          Checking assertions for:
          $(for PAIR in $PAIRS; do
            LEVEL=$(echo "$PAIR" | cut -d: -f1)
            ONTOLOGY=$(echo "$PAIR" | cut -d: -f2)
            echo "- level-$LEVEL/$ONTOLOGY"
          done)

          This PR will be auto-closed after verification.

          ---
          To trigger verification manually:
          \`\`\`
          gh pr edit <number> --remove-label scenarios/needs-verify
          gh pr edit <number> --add-label scenarios/needs-verify
          \`\`\`"

          PR_URL=$(gh pr create --title "verify: scenario assertions" --body "$BODY" --base main --head "$BRANCH")
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

          # Add label
          gh pr edit "$PR_NUMBER" --add-label "scenarios/needs-verify"

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created verification PR #$PR_NUMBER"

      - name: Trigger verification workflow
        if: steps.detect.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"

          # Wait a moment for PR to be fully created
          sleep 3

          # Toggle the label to trigger the verification workflow
          # This works because gh CLI operations with user token CAN trigger workflows
          gh pr edit "$PR_NUMBER" --remove-label "scenarios/needs-verify" || true
          sleep 1
          gh pr edit "$PR_NUMBER" --add-label "scenarios/needs-verify"

          echo "Triggered verification for PR #$PR_NUMBER"

  # Phase 2: On label, run verification agents
  verify:
    if: |
      github.event_name == 'pull_request_target' &&
      contains(github.event.pull_request.labels.*.name, 'scenarios/needs-verify')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Detect ontologies to verify
        id: detect
        run: |
          # Get changed files from the merge that created this PR
          CHANGED=$(git diff --name-only HEAD~1 HEAD)

          PAIRS=""
          for file in $CHANGED; do
            if [[ "$file" =~ ^examples/level-([0-9]+)/([^/]+)/ ]]; then
              PAIR="${BASH_REMATCH[1]}:${BASH_REMATCH[2]}"
              if [[ ! "$PAIRS" =~ "$PAIR" ]]; then
                PAIRS="$PAIRS $PAIR"
              fi
            fi
            if [[ "$file" =~ ^mew/tests/tests/level([0-9]+)_([^.]+)\.rs$ ]]; then
              PAIR="${BASH_REMATCH[1]}:${BASH_REMATCH[2]}"
              if [[ ! "$PAIRS" =~ "$PAIR" ]]; then
                PAIRS="$PAIRS $PAIR"
              fi
            fi
          done

          echo "pairs=$PAIRS" >> $GITHUB_OUTPUT

      - name: Load skill prompt
        id: skill
        run: |
          PAIRS="${{ steps.detect.outputs.pairs }}"
          {
            echo "prompt<<SKILL_EOF"
            echo "# Scenario Verification"
            echo ""
            echo "Verify the following ontologies:"
            for PAIR in $PAIRS; do
              LEVEL=$(echo "$PAIR" | cut -d: -f1)
              ONTOLOGY=$(echo "$PAIR" | cut -d: -f2)
              echo "- Level $LEVEL: $ONTOLOGY"
            done
            echo ""
            cat ".claude/skills/specs->scenarios/verify-scenario.md"
            echo "SKILL_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code - Verify Scenarios
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ steps.skill.outputs.prompt }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_bots: '*'
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 150
            --allowedTools Bash,Read,Glob,Grep,Edit,Write,Task

      - name: Handle verification result
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const { execSync } = require('child_process');

            // Check if any files were modified
            const status = execSync('git status --porcelain').toString().trim();

            if (!status) {
              // No changes needed - close the verification PR
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: '## ✅ Verification Passed\n\nAll scenario assertions are correct. No changes needed.'
              });

              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                state: 'closed'
              });

              // Delete the branch
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              try {
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${pr.data.head.ref}`
                });
              } catch (e) {
                console.log('Could not delete branch:', e.message);
              }

              console.log('Verification passed - PR closed');
            } else {
              // Changes needed - commit and request confirmation
              execSync('git config user.name "github-actions[bot]"');
              execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
              execSync('git add -A');
              execSync('git commit -m "fix: correct scenario assertions"');
              execSync('git push');

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: '## ⚠️ Issues Found\n\nIncorrect assertions detected and fixed. Requesting independent confirmation.'
              });

              // Update labels
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: prNumber,
                name: 'scenarios/needs-verify'
              }).catch(() => {});

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ['scenarios/needs-confirm']
              });

              console.log('Issues found - awaiting confirmation');
            }

  # Phase 3: Confirm fixes independently
  confirm:
    if: |
      github.event_name == 'pull_request_target' &&
      contains(github.event.pull_request.labels.*.name, 'scenarios/needs-confirm')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Load confirm skill
        id: skill
        run: |
          {
            echo "prompt<<SKILL_EOF"
            cat ".claude/skills/specs->scenarios/confirm-fix.md"
            echo "SKILL_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Code - Confirm Fix
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ steps.skill.outputs.prompt }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_bots: '*'
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 80
            --allowedTools Bash,Read,Glob,Grep

      - name: Handle confirmation result
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });

            const labels = pr.labels.map(l => l.name);

            if (labels.includes('verified')) {
              // Auto-merge
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prNumber,
                  merge_method: 'squash',
                  commit_title: 'fix: correct scenario assertions',
                  commit_message: 'Auto-merged after independent verification confirmed fixes.'
                });

                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${pr.head.ref}`
                });

                console.log('PR merged successfully');
              } catch (e) {
                console.log('Merge failed:', e.message);
              }
            } else if (labels.includes('awaiting-human')) {
              console.log('PR requires human review');
            } else {
              console.log('Confirmation incomplete - labels:', labels);
            }
