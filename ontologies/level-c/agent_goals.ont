-- =============================================================================
-- ONTOLOGY: AgentGoals
-- LEVEL: C (Advanced)
-- PURPOSE: Agents with beliefs, desires, intentions, and planning
-- =============================================================================

ontology AgentGoals : Layer0 {

  -- ===========================================================================
  -- NODE TYPES
  -- ===========================================================================

  node Agent {
    name: String [required],
    agent_type: String?,              -- "autonomous", "reactive", "deliberative"
    status: String = "active",        -- "active", "suspended", "terminated"
    created_at: Timestamp?
  }

  node Belief {
    content: String [required],
    confidence: Float = 1.0,
    acquired_at: Timestamp?,
    source: String?
  }

  node Desire {
    description: String [required],
    priority: Float = 0.5,
    temporal: String?,                -- "immediate", "short_term", "long_term"
    status: String = "active"         -- "active", "achieved", "abandoned"
  }

  node Intention {
    description: String [required],
    commitment: Float = 1.0,          -- how committed to this intention
    formed_at: Timestamp?,
    status: String = "pending"        -- "pending", "executing", "completed", "failed"
  }

  node Goal {
    description: String [required],
    goal_type: String?,               -- "achieve", "maintain", "avoid"
    priority: Float = 0.5,
    deadline: Timestamp?,
    status: String = "active"         -- "active", "achieved", "failed", "abandoned"
  }

  node Plan {
    name: String?,
    description: String?,
    status: String = "draft",         -- "draft", "ready", "executing", "completed", "failed"
    created_at: Timestamp?,
    estimated_duration_ms: Int?
  }

  node Action {
    name: String [required],
    action_type: String?,             -- "primitive", "composite"
    preconditions: String?,
    effects: String?,
    duration_ms: Int?
  }

  node Resource {
    name: String [required],
    resource_type: String?,
    capacity: Float?,
    available: Float?
  }

  node WorldState {
    description: String?,
    timestamp: Timestamp [required],
    is_current: Bool = false
  }

  node Percept {
    content: String [required],
    perceived_at: Timestamp [required],
    source: String?
  }

  -- ===========================================================================
  -- EDGE TYPES
  -- ===========================================================================

  -- Mental state relations
  edge believes(agent: Agent, belief: Belief) {}

  edge desires(agent: Agent, desire: Desire) {}

  edge intends(agent: Agent, intention: Intention) {}

  edge has_goal(agent: Agent, goal: Goal) {}

  edge believes_about(belief: Belief, subject: Agent | Goal | WorldState) {}

  -- Goal-intention-plan relations
  edge intention_for(intention: Intention, goal: Goal) {}

  edge plan_for(plan: Plan, goal: Goal) {}

  edge plan_achieves(plan: Plan, intention: Intention) {}

  edge plan_has_step(plan: Plan, action: Action) {
    step_order: Int [required]
  }

  edge step_requires(action: Action, precondition: Belief) {}

  edge step_achieves(action: Action, effect: Belief) {}

  edge subgoal_of(subgoal: Goal, parent: Goal) {}

  -- Resource and world relations
  edge requires_resource(action: Action, resource: Resource) {
    amount: Float?
  }

  edge owns_resource(agent: Agent, resource: Resource) {}

  edge perceives(agent: Agent, percept: Percept) {}

  edge percept_updates(percept: Percept, belief: Belief) {}

  edge state_satisfies(state: WorldState, goal: Goal) {
    satisfaction_degree: Float = 1.0
  }

  -- Higher-order: goal conflict
  edge goal_conflict(
    goal1: edge<has_goal>,
    goal2: edge<has_goal>
  ) {
    conflict_type: String?,           -- "resource", "temporal", "logical"
    severity: Float = 0.5
  }

  -- Higher-order: belief justification
  edge justifies(
    evidence: edge<believes>,
    conclusion: edge<believes>
  ) {
    strength: Float = 1.0
  }

  -- Higher-order: intention commitment based on belief
  edge conditional_on(
    intention: edge<intends>,
    belief: edge<believes>
  ) {
    -- intention depends on belief remaining true
  }

  -- Higher-order: plan dependency
  edge plan_depends_on(
    dependent: edge<plan_for>,
    dependency: edge<plan_for>
  ) {}

  -- Meta: agent's beliefs about own goals
  edge believes_goal_achievable(
    belief: edge<believes>,
    goal: edge<has_goal>
  ) {
    estimated_probability: Float?
  }

  -- ===========================================================================
  -- CONSTRAINTS
  -- ===========================================================================

  -- Confidence and priority in valid range
  constraint belief_confidence_range:
    b: Belief
    => b.confidence >= 0.0 AND b.confidence <= 1.0

  constraint goal_priority_range:
    g: Goal
    => g.priority >= 0.0 AND g.priority <= 1.0

  constraint intention_commitment_range:
    i: Intention
    => i.commitment >= 0.0 AND i.commitment <= 1.0

  -- Plan steps must have positive order
  constraint step_order_positive:
    p: Plan, a: Action, plan_has_step(p, a) AS s
    => s.step_order >= 1

  -- Only one current world state
  constraint single_current_state:
    s1: WorldState, s2: WorldState
    WHERE s1.is_current = true AND s2.is_current = true
    => s1.id = s2.id

  -- Intention must be for a goal the agent has
  constraint intention_valid_goal:
    a: Agent, i: Intention, g: Goal,
    intends(a, i),
    intention_for(i, g)
    => EXISTS(has_goal(a, g))

  -- Achieved goal must have status "achieved"
  constraint achieved_goal_status:
    s: WorldState, g: Goal,
    state_satisfies(s, g) AS sat
    WHERE s.is_current = true AND sat.satisfaction_degree >= 1.0
    => g.status = "achieved"

  -- ===========================================================================
  -- RULES
  -- ===========================================================================

  -- Generate intention from high-priority active goal
  rule adopt_intention [priority: 10]:
    a: Agent, g: Goal,
    has_goal(a, g)
    WHERE g.status = "active" 
      AND g.priority >= 0.7
      AND NOT EXISTS(i: Intention, intends(a, i), intention_for(i, g))
    =>
    CREATE i: Intention {
      description = "Achieve: " + g.description,
      commitment = g.priority,
      formed_at = now(),
      status = "pending"
    },
    CREATE intends(a, i),
    CREATE intention_for(i, g)

  -- Detect goal conflicts (competing resources)
  rule detect_resource_conflict [priority: 8]:
    a: Agent, g1: Goal, g2: Goal, p1: Plan, p2: Plan,
    r: Resource, act1: Action, act2: Action,
    has_goal(a, g1) AS hg1,
    has_goal(a, g2) AS hg2,
    plan_for(p1, g1), plan_for(p2, g2),
    plan_has_step(p1, act1), plan_has_step(p2, act2),
    requires_resource(act1, r), requires_resource(act2, r)
    WHERE g1.id != g2.id
      AND NOT EXISTS(goal_conflict(hg1, hg2))
    =>
    CREATE goal_conflict(hg1, hg2) {
      conflict_type = "resource",
      severity = 0.5
    }

  -- Update belief from percept
  rule percept_to_belief [priority: 12]:
    a: Agent, p: Percept, b: Belief,
    perceives(a, p),
    percept_updates(p, b)
    WHERE NOT EXISTS(believes(a, b))
    =>
    CREATE believes(a, b)

  -- Revise belief confidence from conflicting percepts
  rule revise_belief [priority: 7]:
    a: Agent, b: Belief, p: Percept,
    believes(a, b) AS bel,
    perceives(a, p),
    percept_updates(p, b2: Belief)
    WHERE b.content != b2.content 
      AND p.perceived_at > b.acquired_at
    =>
    SET b.confidence = b.confidence * 0.5

  -- Mark goal achieved when current state satisfies it
  rule check_goal_achieved [priority: 9]:
    a: Agent, g: Goal, s: WorldState,
    has_goal(a, g),
    state_satisfies(s, g) AS sat
    WHERE s.is_current = true 
      AND sat.satisfaction_degree >= 0.9
      AND g.status = "active"
    =>
    SET g.status = "achieved"

  -- Reconsider intention if supporting belief weakens
  rule reconsider_intention [priority: 6]:
    a: Agent, i: Intention, b: Belief,
    intends(a, i) AS int_edge,
    believes(a, b) AS bel_edge,
    conditional_on(int_edge, bel_edge)
    WHERE b.confidence < 0.3 AND i.status = "pending"
    =>
    SET i.commitment = i.commitment * b.confidence,
    SET i.status = "reconsidering"

  -- Propagate subgoal achievement to parent
  rule subgoal_propagation [priority: 5]:
    parent: Goal, sub: Goal,
    subgoal_of(sub, parent)
    WHERE sub.status = "achieved"
      AND parent.status = "active"
      AND NOT EXISTS(
        other: Goal, 
        subgoal_of(other, parent) 
        WHERE other.status != "achieved"
      )
    =>
    SET parent.status = "achieved"

  -- Abandon low-commitment intentions
  rule abandon_intention [priority: 2, auto: false]:
    a: Agent, i: Intention,
    intends(a, i)
    WHERE i.commitment < 0.2 AND i.status = "pending"
    =>
    SET i.status = "abandoned"

}